{% extends 'admin/base.html' %}
{% block branding %}
  <h1 id="site-name">
    <a href="{% url 'admin:index' %}">THE TILE SHOP</a>
  </h1>
{% endblock %}
{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Sales Chart -->
  <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
    <h2 class="text-lg font-semibold mb-4">Sales Chart</h2>
    <div class="relative" style="height: 300px;">
      <canvas id="salesChart"></canvas>
    </div>
  </div>

  <!-- Most Sold Product Chart -->
  <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
    <h2 class="text-lg font-semibold mb-4">Most Sold Product</h2>
    <div class="relative" style="height: 300px;">
      <canvas id="mostSoldChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ months|json_script:"months-data" }}
{{ sales|json_script:"sales-data" }}
{{ product_names|json_script:"product-names-data" }}
{{ units_sold|json_script:"units-sold-data" }}

<script>
const salesLabels = JSON.parse(document.getElementById('months-data').textContent || '[]');
const salesData = JSON.parse(document.getElementById('sales-data').textContent || '[]');
const productLabels = JSON.parse(document.getElementById('product-names-data').textContent || '[]');
const productUnits = JSON.parse(document.getElementById('units-sold-data').textContent || '[]');

// Sales Chart (if data is available)
if (salesLabels.length && salesData.length) {
  new Chart(document.getElementById('salesChart'), {
    type: 'bar',
    data: {
      labels: salesLabels,
      datasets: [{
        label: 'Monthly Sales (₵)',
        data: salesData,
        backgroundColor: 'rgba(59,130,246,0.6)',
        borderColor: 'rgba(59,130,246,1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => '₵' + value.toLocaleString()
          }
        }
      }
    }
  });
}

// Most Sold Product Chart
if (productLabels.length && productUnits.length) {
  new Chart(document.getElementById('mostSoldChart'), {
    type: 'bar',
    data: {
      labels: productLabels,
      datasets: [{
        label: 'Units Sold',
        data: productUnits,
        backgroundColor: 'rgba(16,185,129,0.6)',
        borderColor: 'rgba(5,150,105,1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
      y: {
        beginAtZero: true
      },
      x: {
        ticks: {
          maxRotation: 45,
          minRotation: 0,
          autoSkip: false
        }
      }
    },
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            return `Units Sold: ${context.parsed.y}`;
          }
        }
      }
    }
  }
});
}
  </script>

  <div class="w-full mt-8">
  <h2 class="text-xl font-semibold mb-4">Recent Sales Reports</h2>
  <div class="overflow-x-auto rounded-lg shadow bg-white dark:bg-gray-900">
    <table class="w-full min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50 dark:bg-gray-800">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Sales</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units Sold</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200">
        {% for report in recent_sales_reports %}
        <tr class="hover:bg-gray-100 dark:hover:bg-gray-800 transition">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">{{ report.id }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">{{ report.product }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">{{ report.date_created|date:"Y-m-d H:i" }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">₵{{ report.total_sales }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">{{ report.total_units_sold }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="px-6 py-4 text-center text-gray-500">No sales reports found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
